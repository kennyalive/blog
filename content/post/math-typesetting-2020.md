---
title: "Math typesetting 2020"
date: 2020-01-08T11:54:23+01:00
draft: true
markup: mmark
enable_math: true
---

This page is a playground I used to learn how to incorporate math formulae into a digital content. 

As of 2020 \\(\TeX\\) notation is quite popular. There are few options how to use it on the web. \\(\KaTeX\\) JavaScript library is a solution that is used here.

At first I will describe essensial software configuration and provide a few examples of the math notation in a raw form. For the most part this write-up is an example from computer graphics which derives macrosurface BSDF from a microsurface description.

### Software configuration

*Hugo site generator*. Hugo is a program that consumes content in the form of *Markdown-formatted documents* and produces a web site - a collection of files that can be served by a web server (HTML, CSS, JavaScript, images, etc.). The site structure is specified by a *Hugo theme*. There are a lot of free themes available online. This site was generated by Hugo.

*KaTeX JavaScript library*. It renders mathematical notations. [KaTeX  Auto-render Extension](https://katex.org/docs/autorender.html) provides html snippet that should be included as a child of html `<head>` tag. I had to modify my Hugo theme since it defines the html header.
```xml
  <head>
  .....
  {{ with .Params.enable_math}}
  <!-- Put here html snippet from autorender documentation page -->
  {{ end }}
  </head>
```

*Front matter configuration*. Markdown document processed by Hugo should start with a front matter section that defines a metadata associated with the document. We need to add the following two properties to enable usage of KaTex library: 
* `markup` - allows to set non-default markdown engine. We need this because default engine does not work with KaTeX.
* `enable_math` - our custom property which enables KaTeX library on the given page (by default it is disabled)

```
---
title: "Math typesetting 2020"
date: 2020-01-08T11:54:23+01:00
markup: mmark
enable_math: true
---
```

### Math notation
KaTeX determines what parts of the document contain math by looking for delimiters that surround math snippets. There are two math rendering modes each one is defined by a different pair of delimiters.
* *Inline mode* delimiters are `\\(` and `\\)`. In inline mode math formulate won't break the line, for example, here is the aggigment \\(a=b+c\\) in the middle of this sentense. The corresponding markdown: `\\(a=b+c\\)`

* *Displayed mode* delimiters are `\\[` and `\\]`. In displayed mode the formula adds line breaks and `\\[a=b+c\\]` markdown immediately after the next simicolon is rendered like this: \\[a = b + c\\]

As shown above basic arithmetic operations has natural syntax. Here are some other mathematical operations I used in BSDF derivation:

`\int`\\(\dashrightarrow \int\\) \\
`a \cdot b`  \\(\dashrightarrow a \cdot b \\) \\
`x^2` \\(\dashrightarrow x^2 \\) \\
`x_i` \\(\dashrightarrow x_i \\) \\
`x_i^2` \\(\dashrightarrow x_i^2\\) \\
`\frac{a}{b}` \\(\dashrightarrow \frac{a}{b}\\) \\
`\Phi` \\(\dashrightarrow \Phi\\) \\
`\bold a` \\(\dashrightarrow \bold a\\) \\
`\bigg|` \\(\dashrightarrow \bigg| \\)

The full list of supported \\(\TeX\\) functions can be found in [KaTeX Documentation](https://katex.org/docs/supported.html)

### Macrosurface BSDF derivation example
To have connection with a real world I'm going to do a derivation of macrosurface BSDF for the given microsurface. The final result is provided in "Microfacet Models for Refraction through Rough Surfaces" paper without derivation, see section 3.3. Macrosurface BSDF Integral:

$$ f_s(\bold i, \bold o, \bold n) = 
   \int \bigg| \frac{\bold i \cdot \bold m }{\bold i \cdot \bold n} \bigg|
   f_s^m(\bold i, \bold o, \bold m)
   \bigg| \frac{\bold o \cdot \bold m }{\bold o \cdot \bold n} \bigg|
   G(\bold i, \bold o, \bold m) D(\bold m) d\omega_m $$

The general idea is to compute reflected (or refracted) radiant flux (another term is power - the amount of energy per unit of time). We will compute this quantity two times - at first by using macrosurface BSDF and then through microsurface BSDF. By equating resuls we get the equation (1). For simplicity the wavelength dependency of radiometric quantities is emphesized here. Although the result is true for both reflectance and refraction when computing the flux we need to make a choice if we a dealing with reflected flux or with refracted fllux and in the derivation we will work with reflection. The derivation is also true for refraction.

The reflected radiance is a positive quanity and also to account for refraction where some dot products is negative we take absolute values in corresponding places. One interesting observation is that some properties of shadow-masking function $$G$$ allow to omit taking absolute values in equation (1) because when corresponding ratios are negative then properly designed shadow-masking function should be zero in that case.

###### Flux computation according to macrosurface BSDF $$f_s$$

Differential irradiance when considering differential angle:

$$
dE =L_i d\omega_i (\bold n \cdot \bold i)
$$

That irradiance will be reflected according to BSDF so we have this expression for reflected radiance in the given direction:

$$
dL = f(\bold i, \bold o, \bold n) L_i (\bold n \cdot \bold i) d\omega_i
$$

Reflected irradiance (radiosity):

$$
dM = dL d\omega_o (\bold n \cdot \bold o) =
   f(\bold i, \bold o, \bold n)
   L_i (\bold n \cdot \bold i) (\bold n \cdot \bold o) d\omega_i d\omega_o
$$

Reflected flux:

$$
d\Phi = f_s(\bold i, \bold o, \bold n)L_i
   (\bold n \cdot \bold i)
   (\bold n \cdot \bold o)
   d\omega_i d\omega_o dA
$$

###### Flux computation according to microsurface BSDF $$f_s^m$$

$$
dE_m = L_i d\omega_i (\bold m \cdot \bold i)
$$

$$
dL_m = f_s^m(\bold i, \bold o, \bold m) L_i
   d\omega_i (\bold m \cdot \bold i)
$$

$$
   dM_m = dL_m d\omega_o (\bold m \cdot \bold o)
   = f_s^m(\bold i, \bold o, \bold m) L_i
   (\bold m \cdot \bold i)
   (\bold m \cdot \bold o)
   d\omega_i d\omega_o
$$

$$
   dA_m = D G d\omega_{mi} dA
$$

$$
d\Phi = \int dM_m dA_m = \int f_s^m(\bold i, \bold o, \bold m) L_i
   (\bold m \cdot \bold i)
   (\bold m \cdot \bold o)
   d\omega_i d\omega_o
   D G dA d\omega_{mi}
$$

![microsurface](/math-test/microsurface.png)
